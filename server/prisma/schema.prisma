generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Business {
  id                   String       @id @default(uuid())
  email                String       @unique
  passwordHash         String?
  name                 String
  phone                String?
  businessType         BusinessType @default(OTHER)
  plan                 Plan         @default(STARTER)
  voiceProfile         Json?
  isAdmin              Boolean      @default(false)
  customInstructions   String?      @db.Text
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  // Response settings
  autoPostEnabled      Boolean  @default(false)
  autoPostThreshold    Int      @default(4)    // Auto-post reviews >= this rating
  negativeThreshold    Int      @default(3)    // Reviews <= this are "negative"
  responseTone         String   @default("professional")
  signOffName          String?
  signOffTitle         String?

  // Review display settings
  hideOldReviews          Boolean  @default(false)  // Hide reviews older than threshold
  oldReviewThresholdDays  Int      @default(30)     // Days after which reviews are hidden

  // Google Review Link for QR code generation
  googleReviewUrl      String?

  platformConnections PlatformConnection[]
  reviews             Review[]
  responses           Response[]
}

model PlatformConnection {
  id                String    @id @default(uuid())
  businessId        String
  platform          Platform
  platformAccountId String
  accessToken       String
  refreshToken      String?
  tokenExpiresAt    DateTime?
  isActive          Boolean   @default(true)
  lastSyncAt        DateTime?
  createdAt         DateTime  @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, platform])
}

model Review {
  id               String          @id @default(uuid())
  businessId       String
  platform         Platform
  platformReviewId String          @db.VarChar(500)
  reviewerName     String          @db.VarChar(200)
  rating           Int?
  recommendation   Recommendation?
  reviewText       String
  reviewDate       DateTime
  status           ReviewStatus    @default(NEW)
  isHistorical     Boolean         @default(false) // True for reviews imported on first sync
  createdAt        DateTime        @default(now())

  business Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  response Response?

  @@unique([platform, platformReviewId])
  @@index([businessId, status])
  @@index([businessId, reviewDate])
}

model Response {
  id            String         @id @default(uuid())
  reviewId      String         @unique
  businessId    String
  generatedText String
  finalText     String?
  status        ResponseStatus @default(DRAFT)
  approvedBy    String?
  approvedAt    DateTime?
  postedAt      DateTime?
  postError     String?
  createdAt     DateTime       @default(now())

  review   Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, status])
}

enum BusinessType {
  RESTAURANT
  SALON_SPA
  MEDICAL_OFFICE
  DENTAL_OFFICE
  LEGAL_SERVICES
  HOME_SERVICES
  RETAIL
  AUTOMOTIVE
  FITNESS
  HOSPITALITY
  REAL_ESTATE
  OTHER
}

enum Plan {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum Platform {
  GOOGLE
  FACEBOOK
  YELP
  TRIPADVISOR
}

enum ReviewStatus {
  NEW
  PENDING_RESPONSE
  RESPONDED
  IGNORED
}

enum ResponseStatus {
  DRAFT
  APPROVED
  POSTED
  FAILED
}

enum Recommendation {
  RECOMMENDS
  DOESNT_RECOMMEND
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  ADMIN_VIEW
  ADMIN_UPDATE
}

model AuditLog {
  id         String      @id @default(uuid())
  actor      String      // email of user performing action
  actorType  String      @default("user") // "user", "admin", "system"
  action     AuditAction
  entity     String      // "Business", "Review", "Response", etc.
  entityId   String?
  before     Json?       // state before change
  after      Json?       // state after change
  metadata   Json?       // additional context (IP, user agent, etc.)
  timestamp  DateTime    @default(now())

  @@index([entity, entityId])
  @@index([actor])
  @@index([timestamp])
  @@index([action])
}
